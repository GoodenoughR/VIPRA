\doxysection{output.\+hpp}
\hypertarget{coord__modules_2output_8hpp_source}{}\label{coord__modules_2output_8hpp_source}\index{include/vipra/coord\_modules/output.hpp@{include/vipra/coord\_modules/output.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <filesystem>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <tuple>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ <type\_traits>}}
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}vipra/concepts/output.hpp"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}vipra/concepts/output\_coordinator.hpp"{}}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ "{}vipra/random/random.hpp"{}}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ "{}vipra/types/idx.hpp"{}}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ "{}vipra/types/util/result\_or\_void.hpp"{}}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{keyword}{namespace\ }VIPRA::Module\ \{}
\DoxyCodeLine{00014\ \textcolor{keyword}{template}\ <Concepts::OutputModule...\ output\_ts>}
\DoxyCodeLine{00015\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classVIPRA_1_1Module_1_1Output}{Output}}\ \{}
\DoxyCodeLine{00016\ \ \ \textcolor{comment}{//\ TODO(rolland):\ decide\ if\ we\ need\ std::remove\_reference}}
\DoxyCodeLine{00017\ \ \ \textcolor{comment}{//\ TODO(rolland):\ need\ to\ figure\ out\ how\ to\ get\ paths\ for\ each\ output}}
\DoxyCodeLine{00018\ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/\ if\ multiple\ output\ modules\ use\ the\ same\ parameter,\ how\ do\ we\ split\ them\ up}}
\DoxyCodeLine{00019\ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/\ maybe\ require\ a\ path\ parameter\ for\ each\ output\ module,\ in\ their\ constructor?}}
\DoxyCodeLine{00020\ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/\ this\ would\ require\ a\ recompile\ for\ changing\ paths}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \ \ \textcolor{comment}{//\ TODO(rolland):\ when\ running\ a\ parameter\ sweep\ switch\ output\ directory\ to\ a\ new\ directory\ for\ each\ run}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ output\_t>}
\DoxyCodeLine{00025\ \ \ \textcolor{comment}{//\ NOLINTNEXTLINE(readability-\/identifier-\/naming)\ helper\ struct}}
\DoxyCodeLine{00026\ \ \ \textcolor{keyword}{struct\ }write\_helper\ \{}
\DoxyCodeLine{00027\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classVIPRA_1_1Module_1_1Output_af940a530a4a1ff93ca0635744410af8d}{write}}(output\_t\&\ output,\ std::filesystem::path\ \textcolor{keyword}{const}\&\ dir)\ \{}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (std::is\_same\_v<Util::result\_or\_VOID\_t<decltype(std::declval<output\_t>().write(dir))>,}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structVIPRA_1_1VOID}{VOID}}>)\ \{}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ output.write(dir);}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{structVIPRA_1_1VOID}{VOID}}\{\};}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ output.write(dir);}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00035\ \ \ \ \ \}}
\DoxyCodeLine{00036\ \ \ \};}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00039\ \ \ \textcolor{comment}{//\ NOLINTNEXTLINE}}
\DoxyCodeLine{00040\ \ \ \textcolor{keyword}{constexpr}\ \textcolor{keyword}{static}\ VIPRA::Modules::Type\ \_VIPRA\_MODULE\_TYPE\_\ =\ VIPRA::Modules::Type::OUTPUT;}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \textcolor{keyword}{constexpr}\ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{classVIPRA_1_1Module_1_1Output}{Output}}(output\_ts...\ outputs)\ :\ \_outputs(std::make\_tuple(outputs...))\ \{\}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \textcolor{keywordtype}{void}\ new\_run(VIPRA::idx\ runIdx)\ \{}
\DoxyCodeLine{00045\ \ \ \ \ \_current\_output\_dir\ =\ \_base\_output\_dir\ /\ std::to\_string(runIdx);}
\DoxyCodeLine{00046\ \ \ \ \ create\_output\_directory(\_current\_output\_dir);}
\DoxyCodeLine{00047\ \ \ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00054\ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classVIPRA_1_1Module_1_1Output_af940a530a4a1ff93ca0635744410af8d}{write}}()\ -\/>\ std::tuple<Util::result\_or\_VOID\_t<}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \textcolor{keyword}{decltype}(std::declval<output\_ts>().write(std::declval<std::filesystem::path>()))>...>\ \{}
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{keywordflow}{return}\ std::apply(}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ [\&](\textcolor{keyword}{auto}\&\&...\ outputs)\ \{}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ std::make\_tuple(write\_helper<\textcolor{keyword}{decltype}(outputs)>\mbox{\hyperlink{classVIPRA_1_1Module_1_1Output_af940a530a4a1ff93ca0635744410af8d}{::write}}(outputs,\ \_current\_output\_dir)...);}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \},}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \_outputs);}
\DoxyCodeLine{00061\ \ \ \}}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00068\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVIPRA_1_1Module_1_1Output_ab97eb18417f8dd73458a4fe080eaa282}{config}}(\textcolor{keyword}{auto}\ \textcolor{keyword}{const}\&\ params,\ \mbox{\hyperlink{classVIPRA_1_1Random_1_1Engine}{VIPRA::Random::Engine}}\&\ engine)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \_base\_output\_dir\ =\ params.template\ get\_param<std::string>(VIPRA::Modules::Type::OUTPUT,\ \textcolor{stringliteral}{"{}coordinator"{}},}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}output\_dir"{}},\ engine);}
\DoxyCodeLine{00071\ \ \ \ \ \_current\_output\_dir\ =\ \_base\_output\_dir;}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ \ \ create\_output\_directory(\_current\_output\_dir);}
\DoxyCodeLine{00074\ \ \ \ \ std::apply([\&](\textcolor{keyword}{auto}\&\&...\ outputs)\ \{\ (outputs.config(params,\ engine),\ ...);\ \},\ \_outputs);}
\DoxyCodeLine{00075\ \ \ \}}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00082\ \ \ \textcolor{keyword}{template}\ <Concepts::ParamModule\ params\_t>}
\DoxyCodeLine{00083\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVIPRA_1_1Module_1_1Output_a9cec322d316fbfb65307d5cf2c947fd6}{register\_params}}(params\_t\&\ params)\ \{}
\DoxyCodeLine{00084\ \ \ \ \ params.register\_param(VIPRA::Modules::Type::OUTPUT,\ \textcolor{stringliteral}{"{}coordinator"{}},\ \textcolor{stringliteral}{"{}output\_dir"{}});}
\DoxyCodeLine{00085\ \ \ \ \ std::apply([\&](\textcolor{keyword}{auto}\&\&...\ outputs)\ \{\ (outputs.template\ register\_params<params\_t>(params),\ ...);\ \},}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_outputs);}
\DoxyCodeLine{00087\ \ \ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00095\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVIPRA_1_1Module_1_1Output_accadfd50c6c8d1819eb9a004947a3e75}{sim\_value}}(\textcolor{keywordtype}{char}\ \textcolor{keyword}{const}*\ key,\ \textcolor{keyword}{auto}\&\&\ value)\ \{}
\DoxyCodeLine{00096\ \ \ \ \ std::apply([\&key,\ \&value](\textcolor{keyword}{auto}\&\&...\ outputs)\ \{\ (outputs.sim\_value(key,\ value),\ ...);\ \},\ \_outputs);}
\DoxyCodeLine{00097\ \ \ \}}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00105\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVIPRA_1_1Module_1_1Output_a920823cf3769873e5df11578ce3dfc5e}{timestep\_value}}(\textcolor{keywordtype}{char}\ \textcolor{keyword}{const}*\ key,\ VIPRA::timestep\ timestep,\ \textcolor{keyword}{auto}\&\&\ value)\ \{}
\DoxyCodeLine{00106\ \ \ \ \ std::apply(}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ [\&key,\ \&timestep,\ \&value](\textcolor{keyword}{auto}\&\&...\ outputs)\ \{\ (outputs.timestep\_value(key,\ timestep,\ value),\ ...);\ \},}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \_outputs);}
\DoxyCodeLine{00109\ \ \ \}}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00118\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVIPRA_1_1Module_1_1Output_af47b0dffcbd33fbe14425f4a9f4533ef}{ped\_value}}(VIPRA::idx\ pedIdx,\ \textcolor{keywordtype}{char}\ \textcolor{keyword}{const}*\ key,\ \textcolor{keyword}{auto}\&\&\ value)\ \{}
\DoxyCodeLine{00119\ \ \ \ \ std::apply([\&pedIdx,\ \&key,\ \&value](\textcolor{keyword}{auto}\&\&...\ outputs)\ \{\ (outputs.ped\_value(pedIdx,\ key,\ value),\ ...);\ \},}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_outputs);}
\DoxyCodeLine{00121\ \ \ \}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00130\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVIPRA_1_1Module_1_1Output_ab7952ad1312ca51dfabfc104005e00d7}{ped\_timestep\_value}}(VIPRA::idx\ pedIdx,\ VIPRA::timestep\ timestep,\ \textcolor{keywordtype}{char}\ \textcolor{keyword}{const}*\ key,\ \textcolor{keyword}{auto}\&\&\ value)\ \{}
\DoxyCodeLine{00131\ \ \ \ \ std::apply([\&pedIdx,\ \&timestep,\ \&key,\ \&value](}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\&...\ outputs)\ \{\ (outputs.ped\_timestep\_value(pedIdx,\ timestep,\ key,\ value),\ ...);\ \},}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_outputs);}
\DoxyCodeLine{00134\ \ \ \}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00137\ \ \ std::tuple<output\_ts...>\ \_outputs;}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ std::filesystem::path\ \_base\_output\_dir;}
\DoxyCodeLine{00140\ \ \ std::filesystem::path\ \_current\_output\_dir;}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ create\_output\_directory(std::filesystem::path\ \textcolor{keyword}{const}\&\ directory)\ \{}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{keywordflow}{if}\ (std::filesystem::exists(directory))\ \{}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (std::filesystem::is\_directory(directory))\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Output\ directory\ already\ exists\ and\ is\ not\ a\ directory:\ "{}}\ +}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ directory.string());}
\DoxyCodeLine{00150\ \ \ \ \ \}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keywordflow}{if}\ (!std::filesystem::create\_directory(directory))\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!std::filesystem::exists(directory))}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Could\ not\ create\ output\ directory:\ "{}}\ +\ directory.string());}
\DoxyCodeLine{00155\ \ \ \ \ \}}
\DoxyCodeLine{00156\ \ \ \}}
\DoxyCodeLine{00157\ \};}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ CHECK\_MODULE(OutputCoordinator,\ Output<Concepts::DummyOutput>);}
\DoxyCodeLine{00160\ \}\ \ \textcolor{comment}{//\ namespace\ VIPRA::Module}}

\end{DoxyCode}
